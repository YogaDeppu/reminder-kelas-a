name: Auto Reminder CRON

on:
  schedule:
    # Runs at 7 AM WIB (0 AM UTC) every day
    - cron: '0 0 * * *'
    # Runs at 7 PM WIB (12 PM UTC) every day
    - cron: '0 12 * * *'
  
  # Allows manual trigger from GitHub Actions tab
  workflow_dispatch:

jobs:
  trigger-cron:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Set Timezone
        run: |
          echo "Current UTC time: $(date -u)"
          echo "WIB time: $(TZ='Asia/Jakarta' date)"
      
      - name: Trigger CRON on InfinityFree
        id: trigger
        env:
          CRON_URL: ${{ secrets.CRON_URL }}
        run: |
          echo "üöÄ Triggering CRON at $(TZ='Asia/Jakarta' date)"
          
          # Get HTTP status code and response
          http_code=$(curl -s -o response.txt -w "%{http_code}" -X GET "$CRON_URL" \
            -H "User-Agent: GitHub-Actions-CRON" \
            --max-time 30 \
            --retry 3 \
            --retry-delay 5)
          
          echo "HTTP Status Code: $http_code"
          
          if [ $http_code -eq 200 ]; then
            echo "‚úÖ CRON triggered successfully (HTTP $http_code)"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå CRON failed with HTTP $http_code"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Display Response
        if: always()
        run: |
          echo "üìÑ Response from server:"
          echo "========================"
          if [ -f response.txt ]; then
            cat response.txt
            echo ""
            echo "========================"
          else
            echo "‚ö†Ô∏è No response file found"
          fi
      
      - name: Check Response Content
        if: success()
        run: |
          echo "üîç Analyzing response content..."
          
          if [ -f response.txt ]; then
            # Check if response contains success indicators
            if grep -qi "success\|berhasil\|sent\|terkirim" response.txt; then
              echo "‚úÖ Response indicates successful execution"
            elif grep -qi "error\|gagal\|failed" response.txt; then
              echo "‚ö†Ô∏è Response contains error messages"
              cat response.txt
            else
              echo "‚ÑπÔ∏è Response received but status unclear"
              cat response.txt
            fi
          fi
      
      - name: Log Execution Summary
        if: always()
        run: |
          echo "üìä Execution Summary"
          echo "===================="
          echo "Workflow: ${{ github.workflow }}"
          echo "Run Number: ${{ github.run_number }}"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Status: ${{ steps.trigger.outputs.status || 'unknown' }}"
          echo "Time: $(TZ='Asia/Jakarta' date)"
          echo "===================="
      
      - name: Notify on Failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CRON JOB FAILED ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è"
          echo ""
          echo "Please check the following:"
          echo "1. Is the server accessible?"
          echo "2. Is the CRON_URL secret configured correctly?"
          echo "3. Check the response details above"
          echo ""
          echo "You can manually re-run this workflow from the Actions tab."
